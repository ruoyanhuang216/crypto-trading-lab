# Session Log — 2026-02-28

**Focus:** Walk-forward validation engine (P4), long-only MeanReversion experiment (P1b),
and ML feature engineering foundation (P-ML1).

---

## Work completed

### P4 — Walk-forward validation engine ✅
Implemented `backtesting/walk_forward.py` with `WindowResult` / `WalkForwardResult` dataclasses,
`_make_splits` (rolling + anchored modes), `_stitch_equity` (multiplicative chaining),
and `walk_forward()` with an `optimize_fn` hook reserved for Optuna (P7).

Exported from `backtesting/__init__.py`. Smoke-test passes (MACrossover, 5 splits, rolling).

Notebook `notebooks/walk_forward_backtest.ipynb` validated on full-year 2024 BTC/USDT 1h:
- BollingerMeanReversion rolling WF (5 folds) — summary_df, per-window equity panels
- Anchored vs rolling OOS comparison
- MeanReversion vs Breakout WF side-by-side

**Key takeaway:** confirms F4 — per-window Sharpe ranges from −4.7 to +1.2 for the same
strategy on the same year. Single-period backtest results are meaningless without WF.

---

### P1b — Long-only MeanReversion variant ✅ → F6
Tested three variants of BollingerMeanReversion on full-year 2024 via the P4 WF engine.

**Results (walk-forward OOS, 5 rolling folds):**

| Variant | WF Sharpe | Return | MaxDD |
|---|---|---|---|
| Baseline (long+short) | −1.12 | −20.6% | −33.5% |
| **LongOnly** | **−0.18** | **−3.6%** | −18.9% |
| TrendFiltered (200MA) | −0.93 | −7.0% | −12.1% |

- LongOnly is 5× better in return terms — removing short signals eliminates the structural
  bull-market losses.
- TrendFiltered with MA=200 is over-filtered: only 284/8785 bars trade actively.
  Better MaxDD but lower Sharpe than LongOnly.
- **No variant profitable in 2024** — signal scarcity (5.7% of bars touch lower BB) is the
  binding constraint, not direction. Bollinger mean-reversion at 1h cannot generate alpha in a
  strongly trending year regardless of long/short bias.

**Action:** Promote `BollingerLongOnly` to `strategies/single/basic/` (P-next).
Park `BollingerTrendFiltered` for P5 (regime-aware strategy) with a shorter MA period.

---

### P-ML1 — ML feature engineering & IC analysis ✅ → F7
Built the `ml/` module from scratch as a new top-level package alongside `strategies/` and `signals/`:

```
ml/
├── features/
│   ├── technical.py   # 10 features: RSI, BB width/%B/zscore, ATR%, MACD hist, volume, Stoch, ADX, DI diff
│   ├── lag.py         # 20 features: lagged returns, rolling mean/std/skew, bar structure, wicks
│   └── time.py        # 4 features: hour sin/cos, DOW sin/cos
├── labels/
│   └── returns.py     # forward_return(), direction_label()
```

`build_feature_matrix(df)` → 34 features, all causal (no lookahead), normalised (dimensionless).

**IC analysis results (Spearman, 1h, h=1 bar, n=8763):**

- All top features are **negative IC** — mean reversion is the dominant predictable structure
- `bar_ret` and `ret_lag1` both IC = −0.081 (strongest; they are identical calculations)
- 15/34 features exceed |IC| = 0.02; mean |IC| = 0.024
- IC is **flat across horizons** (0.022–0.025 for h=1..48) — no improvement at longer horizons at 1h
- **Daily IC = 0.041** (70% higher than 1h); `upper_wick` at 1d hits IC = 0.165

**Autocorrelation findings:**
- Raw returns: Ljung-Box p > 0.05 (lags 5/10/20) — no linear autocorrelation
- Squared returns: Ljung-Box p ≈ 0 — strong GARCH volatility clustering

**Feature redundancy:**
- 27 pairs with |r| > 0.7; `ret_lag1` = `bar_ret` (|r| = 1.0 — identical)
- Oscillator cluster: RSI ≈ Stoch_K ≈ BB_pct_B (pick one)
- Volatility cluster: ATR_pct ≈ BB_width ≈ ret_std_20 (pick two)

**Recommended 12-feature set for LightGBM:**
`bar_ret`, `bb_zscore`, `rsi`, `macd_hist_norm`, `atr_pct`, `bb_width`,
`upper_wick`, `lower_wick`, `hl_range`, `vol_log_chg`, `di_diff`, `adx`

---

## Findings logged today

- **F6** — Long-only bias reduces WF losses 5× but signal scarcity prevents profitability
- **F7** — IC analysis: mean reversion dominates at 1h; daily IC 70% higher; GARCH effect confirmed

---

## PRs merged today

| PR | Title |
|---|---|
| #5 | feat(P4): walk-forward validation engine |
| #6 | feat(P1b): long-only MeanReversion experiment + finding F6 |
| #7 | feat(P-ML1): ML feature engineering module + IC analysis (F7) |

---

## Next session priorities

1. **P-ML2** — LightGBM baseline model on 1d data (12-feature set, purged WF, 5 folds)
2. **P2** — Volatility signals (`bb_width.py`, `atr.py`) in `signals/volatility/`
3. **Promote `BollingerLongOnly`** to `strategies/single/basic/bollinger_bands.py`
